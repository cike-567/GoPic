# GoPic

这是一个用 Go 构建的简单随机图服务器应用。它可以从文件或远程 URL 获取图片，支持压缩（Gzip 和 Brotli），并且使用轻量级缓存加速响应。

这个项目是我使用 AI 编写，它的诞生有以下几个原因：

- 给我的[博客](jmdonj.com)提供服务
- 测试 AI 编写代码的能力
- 测试普通人在 AI 的帮助下，能否顺利编写代码。

按我的测试结果来说，目前 AI 编写代码的能力处于半自动化的水平。举个例子来说，如果把编写代码比作组装机器，那么当前的 AI 就像是使用电动螺丝刀来拧螺丝。手动螺丝刀代表完全依赖人工操作，而电动螺丝刀则是在一定程度上提供了自动化帮助，例如自动生成代码片段、提供代码建议或自动完成某些任务，但整体过程仍然需要开发者的介入和指导。

对于稍微复杂的任务，AI 出错的概率不低。AI 可能难以全面理解项目背景、业务逻辑或特定领域的复杂性，导致生成的代码不符合实际需求。在处理异常情况或边界条件时，AI可能无法像经验丰富的开发者那样准确地预测和处理潜在的错误。

普通人使用 AI 编写出的代码，可能可以运行，但不一定高效率运行。AI 生成的代码可能在逻辑上是正确的，但不一定是最优的。例如，算法的选择、数据结构的使用、循环的优化等方面可能不如经验丰富的开发者做得好。在内存管理和 CPU 使用方面可能不够高效，导致程序运行缓慢或占用过多资源。在安全性方面可能存在漏洞，如 SQL 注入、跨站脚本攻击等，需要额外的安全审查和加固。

AI 可以在一些简单的任务中提高开发效率，特别是在生成简单代码片段或是提供代码建议方面，但在处理复杂的项目和高要求的应用时，仍然需要开发者的深入参与和细致校验，结合专业知识和经验，以确保最终代码的质量和可靠性。

## 一、特性

- **图片来源**：支持从本地文件系统或远程 URL 加载图片。
- **压缩支持**：自动启用 Gzip 和 Brotli 压缩以优化带宽。
- **图片缓存**：使用 [Ristretto](https://github.com/dgraph-io/ristretto) 实现高效的图片缓存，提升访问速度。
- **配置灵活**：支持通过环境变量或 `.env` 文件进行配置。
- **访问控制**：基于 IP 和主机名的白名单机制（支持 IPv6）。
- **随机图片**：每次访问 `/random-image` 时返回一张随机图片。
- **自定义主页**：可以通过 `index.html` 文件自定义首页内容。

## 二、系统要求

- Go 1.22.5 或更高版本（本项目基于此版本进行开发）

- 依赖的库：

  - Ristretto 库

  - Fasthttp 库

  - bytes 库

  - mime 库

  - path/filepath 库

  - github.com/dgraph-io/ristretto 库

  - github.com/valyala/fasthttp 库

  - golang.org/x/sync/semaphore 库

  - github.com/andybalholm/brotli 库

  - compress/gzip 库

  - bufio 库

  - fmt 库

  - os 库

  - strings 库

  - sync 库

  - math/rand 库

  - time 库

  - context 库

## 三、安装与运行

1. 克隆代码库：

    ```bash
    git clone https://github.com/cike-567/GoPic.git
    ```

2. 安装 Go 环境

    如果还没有安装 Go，需要先安装 Go 环境。可以从 [Go 官方网站](https://go.dev/dl/) 下载并安装 Go。

    安装完成后，您可以通过运行以下命令来验证 Go 是否已正确安装：

    ```bash
    go version
    ```

    确保返回的版本号与您安装的版本一致。

3. 安装依赖：
    进入克隆下来的项目目录，通常项目里会有一个 `go.mod` 文件，该文件定义了项目的依赖。

    ```bash
    cd GoPic
    go mod tidy
    ```

    `go mod tidy` 命令会自动下载项目所需的所有依赖包。

4. 构建应用程序：

	```bash
	go build -o random_image_server
	```

5. 准备需要的文件：

   按照 “**配置**” 部分的说明创建 `.env` 文件、CSV 文件和图片文件。如果不想使用 `.env` 文件，也可以使用环境变量。有一点要注意，不同种类的系统创建的 `.env` 文件有些许不同，不能通用。建议是在哪里运行就在哪里准备需要的文件。详细配置项说明见下文。

6. 运行服务器：

   ```bash
   ./random_image_server
   ```

7. 打开浏览器访问 `http://localhost:9090/` 就可以查看程序的效果。

## 四、配置

您可以通过使用以下环境变量或创建 `.env` 文件来配置应用程序，环境变量与 `.env` 文件中的键相同。仓库中有对应的示例文件，可供参考：

| 变量                    | 默认值                 | 描述                                                                  |
|-------------------------|-----------------------|-----------------------------------------------------------------------|
| `BASE_URL`              | `./images`            | 图片的基础 URL 或路径。                                              |
| `CSV_PATH`              | `./url.csv`           | 包含图片文件名的 CSV 文件路径。                                      |
| `IMAGE_URL_TYPE`        | `localpath`           | 图片 URL 类型：`localpath` 或 `networkpath`。 |
| `PORT`                  | `9090`                | HTTP 服务器端口。                                                |
| `PRELOAD_IMAGES`        | `false`               | 是否在服务器启动时预加载图片。       |
| `ENABLE_COMPRESSION`    | `true`                | 是否启用压缩（支持 Gzip 和 Brotli）。                  |
| `INDEX_HTML_PATH`       | `./index.html`        | 首页 HTML 文件路径，可自定义 HTML 文件的内容。    |
| `WHITELIST`             | `localhost,127.0.0.1` | 允许访问的 IP 地址和主机名列表（逗号分隔）。 |
| `GZIP_LEVEL`            | `-1`                  | Gzip 压缩级别（0-9）。                                              |
| `BROTLI_LEVEL`          | `6`                   | Brotli 压缩级别（0-11）。                                           |

- `BASE_URL`：设置图片存储位置。如果是本地路径，则指向本地目录；如果是网络路径（如 URL），则设置为完整 URL。
- `CSV_PATH`：配置图片文件名的 CSV 文件路径，该文件应包含图片文件名（每行一个）。
- `IMAGE_URL_TYPE`：`localpath` 表示图片来自本地文件系统，`networkpath` 则表示图片 URL 为网络路径。
- `PRELOAD_IMAGES`：如果设置为 `true`，服务器启动时会预加载所有图片到缓存。
- `ENABLE_COMPRESSION`：启用压缩可以减少网络带宽消耗，提高访问速度。

## 五、API 接口

### （一） 获取主页

- **请求方式**: `GET`
- **路径**: `/`
- **说明**: 返回主页 HTML 内容。
- **示例**: 访问 `http://localhost:9090/`。

### （二） 获取随机图片

- **请求方式**: `GET`
- **路径**: `/random-image`
- **说明**: 返回一张随机选择的图片。
- **示例**: 访问 `http://localhost:9090/random-image`。

### （三） 错误响应

如果访问的路径不存在，服务器会返回 `404 Not Found` 错误。

## 六、缓存机制

本项目使用 Ristretto 实现轻量级图片缓存。当请求图片时，服务器会优先从缓存中获取，减少磁盘访问，提高响应速度。可以通过配置 `PRELOAD_IMAGES` 控制是否在启动时预加载图片。

## 七、访问控制

具有内置的访问控制机制。可以使用 `WHITELIST` 变量来指定允许的 IP 和主机名白名单。来自不在白名单中的 IP 或主机名的请求将被重定向到预定义的 URL。

> 访问控制规则：IP 地址优先。即使域名在白名单中，如果其对应的 IP 不在白名单内，访问仍然会被拒绝。

## 八、未来计划

- 支持配置最大并发请求数，控制服务器负载。
- 扩展缓存的配置选项，提供更多自定义功能。


## 九、故障排除

如果遇到问题，请确保以下几点：

- `.env` 文件或环境变量已正确配置。
- 指定的 CSV 文件存在并包含有效的图片文件名。
- 服务器有权限读取相关文件。

## 十、许可证

该项目根据 MIT 许可证授权。详细信息请参见 LICENSE 文件。
